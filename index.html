<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é£Ÿè°±å¹³å°</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .container {
            border: 1px solid #ccc;
            padding: 2rem;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: .5rem;
            font-weight: bold;
        }

        input,
        textarea {
            width: 100%;
            padding: .5rem;
            margin-bottom: .5rem;
        }

        button {
            background-color: #0078d4;
            color: white;
            padding: .5rem 1rem;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #005a9e;
        }

        #status {
            margin-top: 1rem;
            padding: 1rem;
            display: none;
        }

        .success {
            background-color: #dff6dd;
            color: #107c10;
        }

        .error {
            background-color: #fde7e9;
            color: #a80000;
        }

        img {
            max-width: 300px;
            margin-top: 10px;
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ³ ä¸Šä¼ æ–°é£Ÿè°±</h1>

        <div class="form-group">
            <label>1. å…ˆä¸Šä¼ é£Ÿè°±å°é¢å›¾</label>
            <input type="file" id="imageFile" accept="image/*">
            <button onclick="uploadImage()">ä¸Šä¼ å›¾ç‰‡</button>
            <p id="imageStatus" style="font-size: 0.9em; color: gray;"></p>
            <img id="previewImg" src="" style="display:none;">
        </div>

        <hr>

        <div class="form-group">
            <label>2. å¡«å†™é£Ÿè°±è¯¦æƒ…</label>
            <input type="text" id="title" placeholder="é£Ÿè°±åç§° (æ¯”å¦‚: è¥¿çº¢æŸ¿ç‚’è›‹)">
            <textarea id="description" rows="3" placeholder="ç®€çŸ­æè¿°..."></textarea>
            <input type="text" id="ingredients" placeholder="é…æ–™ (ç”¨é€—å·éš”å¼€ï¼Œæ¯”å¦‚: é¸¡è›‹,è¥¿çº¢æŸ¿,è‘±)">
            <input type="text" id="steps" placeholder="æ­¥éª¤ (ç”¨é€—å·éš”å¼€ï¼Œæ¯”å¦‚: åˆ‡èœ,ç‚’èœ,å‡ºé”…)">

            <input type="hidden" id="uploadedImageUrl">

            <button onclick="submitRecipe()" style="width: 100%; margin-top: 10px; font-size: 1.1em;">æäº¤é£Ÿè°±</button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        // ==========================================
        // ğŸ”´ è¿™é‡Œçš„ URL æ˜¯ä¸æ˜¯ä½ åˆšæ‰å¡«çš„é‚£ä¸ªï¼Ÿè¯·æ£€æŸ¥ï¼
        // ==========================================
        const API_BASE_URL = "https://recipe-api-jiarun-h2hwd6dufzech6es.uksouth-01.azurewebsites.net/api";

        async function uploadImage() {
            const fileInput = document.getElementById('imageFile');
            const status = document.getElementById('imageStatus');
            const file = fileInput.files[0];

            if (!file) { alert("è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼"); return; }

            status.innerText = "æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...";

            const formData = new FormData();
            formData.append('file', file);

            try {
                // è°ƒç”¨ä¸Šä¼ å›¾ç‰‡çš„æ¥å£
                const response = await fetch(`${API_BASE_URL}/UploadMedia`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    status.innerText = "âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼";
                    // æŠŠè¿”å›çš„å›¾ç‰‡ URL å­˜èµ·æ¥
                    document.getElementById('uploadedImageUrl').value = data.url;
                    // æ˜¾ç¤ºé¢„è§ˆ
                    document.getElementById('previewImg').src = data.url;
                    document.getElementById('previewImg').style.display = 'block';
                } else {
                    status.innerText = "âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥";
                }
            } catch (error) {
                console.error(error);
                status.innerText = "âŒ ç½‘ç»œé”™è¯¯: " + error.message;
            }
        }

        async function submitRecipe() {
            const status = document.getElementById('status');
            const title = document.getElementById('title').value;
            const imageUrl = document.getElementById('uploadedImageUrl').value;

            if (!title) { alert("è¯·è¾“å…¥æ ‡é¢˜ï¼"); return; }
            if (!imageUrl) { alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼"); return; }

            status.style.display = 'block';
            status.className = '';
            status.innerText = "æ­£åœ¨ä¿å­˜é£Ÿè°±...";

            const recipeData = {
                title: title,
                description: document.getElementById('description').value,
                ingredients: document.getElementById('ingredients').value.split(','),
                steps: document.getElementById('steps').value.split(','),
                main_photo_url: imageUrl  // æŠŠåˆšæ‰çš„å›¾ç‰‡é“¾æ¥å¸¦ä¸Š
            };

            try {
                // è°ƒç”¨ä¸Šä¼ é£Ÿè°±çš„æ¥å£
                const response = await fetch(`${API_BASE_URL}/UploadRecipe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recipeData)
                });

                if (response.ok) {
                    status.className = 'success';
                    status.innerHTML = "ğŸ‰ <b>å¤§åŠŸå‘Šæˆï¼</b> é£Ÿè°±å·²ä¿å­˜åˆ°äº‘ç«¯æ•°æ®åº“ï¼";
                } else {
                    status.className = 'error';
                    status.innerText = "ä¿å­˜å¤±è´¥: " + await response.text();
                }
            } catch (error) {
                status.className = 'error';
                status.innerText = "ç½‘ç»œé”™è¯¯: " + error.message;
            }
        }
    </script>
</body>

</html>